{"version":3,"sources":["../login.js"],"names":["akeeba_passwordless_findField","elForm","fieldSelector","elInputs","querySelectorAll","length","akeeba_passwordless_lookInParentElementsForField","innerElement","elElement","parentElement","elInput","undefined","nodeName","elForms","i","akeeba_passwordless_login","that","callback_url","elUsername","elReturn","alert","Joomla","JText","_","username","value","returnUrl","postBackData","window","jQuery","ajax","type","url","data","dataType","done","jsonData","akeeba_passwordless_handle_login_challenge","fail","error","akeeba_passwordless_handle_login_error","status","statusText","publicKey","arrayToBase64String","a","btoa","String","fromCharCode","challenge","Uint8Array","from","atob","c","charCodeAt","allowCredentials","map","id","navigator","credentials","get","then","publicKeyCredential","rawId","response","authenticatorData","clientDataJSON","signature","userHandle","location","JSON","stringify","console","log","message","akeeba_passwordless_login_move_button","elPasswordlessLoginButton","possibleSelectors","elLoginBtn","selector","appendChild"],"mappings":"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","sourcesContent":["/**\n * @package   AkeebaPasswordlessLogin\n * @copyright Copyright (c)2018-2019 Nicholas K. Dionysopoulos / Akeeba Ltd\n * @license   GNU General Public License version 3, or later\n */\n\n// TODO Write the akeeba_passwordless_login() function\n// See https://github.com/web-auth/webauthn-framework/blob/v1.0/doc/webauthn/PublicKeyCredentialRequest.md\n\n/**\n * Finds the first field matching a selector inside a form\n *\n * @param   {HTMLFormElement}  elForm         The FORM element\n * @param   {String}           fieldSelector  The CSS selector to locate the field\n *\n * @returns {Element|null}  NULL when no element is found\n */\nfunction akeeba_passwordless_findField(elForm, fieldSelector)\n{\n    let elInputs = elForm.querySelectorAll(fieldSelector);\n\n    if (!elInputs.length)\n    {\n        return null;\n    }\n\n    return elInputs[0];\n}\n\n/**\n * Walks the DOM outwards (towards the parents) to find the form innerElement is located in. Then it looks inside the\n * form for the first element that matches the fieldSelector CSS selector.\n *\n * @param   {Element}  innerElement   The innerElement that's inside or adjacent to the form.\n * @param   {String}   fieldSelector  The CSS selector to locate the field\n *\n * @returns {null|Element}  NULL when no element is found\n */\nfunction akeeba_passwordless_lookInParentElementsForField(innerElement, fieldSelector)\n{\n    var elElement = innerElement.parentElement;\n    var elInput   = null;\n\n    while (true)\n    {\n        if (elElement === undefined)\n        {\n            return null;\n        }\n\n        if (elElement.nodeName === \"FORM\")\n        {\n            elInput = akeeba_passwordless_findField(elElement, fieldSelector);\n\n            if (elInput !== null)\n            {\n                return elInput;\n            }\n\n            break;\n        }\n\n        var elForms = elElement.querySelectorAll(\"form\");\n\n        if (elForms.length)\n        {\n            for (var i = 0; i < elForms.length; i++)\n            {\n                elInput = akeeba_passwordless_findField(elForms[i], fieldSelector);\n\n                if (elInput !== null)\n                {\n                    return elInput;\n                }\n            }\n\n            break;\n        }\n\n        if (!elElement.parentElement)\n        {\n            break;\n        }\n\n        elElement = elElement.parentElement;\n    }\n\n    return null;\n}\n\n/**\n * Initialize the passwordless login, going through the server to get the registered certificates for the user.\n *\n * @param   {Element}  that          The button which was clicked\n * @param   {string}   callback_url  The URL we will use to post back to the server. Must include the anti-CSRF token.\n *\n * @returns {boolean}  Always FALSE to prevent BUTTON elements from reloading the page.\n */\nfunction akeeba_passwordless_login(that, callback_url)\n{\n    // Get the username\n    let elUsername = akeeba_passwordless_lookInParentElementsForField(that, \"input[name=username]\");\n    let elReturn   = akeeba_passwordless_lookInParentElementsForField(that, \"input[name=return]\");\n\n    if (elUsername === null)\n    {\n        alert(Joomla.JText._(\"PLG_SYSTEM_WEBAUTHN_ERR_CANNOT_FIND_USERNAME\"));\n\n        return false;\n    }\n\n    let username  = elUsername.value;\n    let returnUrl = elReturn ? elReturn.value : null;\n\n    // No username? We cannot proceed. We need a username to find the acceptable public keys :(\n    if (username === \"\")\n    {\n        alert(Joomla.JText._(\"PLG_SYSTEM_WEBAUTHN_ERR_EMPTY_USERNAME\"));\n\n        return false;\n    }\n\n    // Get the Public Key Credential Request Options (challenge and acceptable public keys)\n    let postBackData = {\n        \"option\":    \"com_ajax\",\n        \"group\":     \"system\",\n        \"plugin\":    \"webauthn\",\n        \"format\":    \"raw\",\n        \"akaction\":  \"challenge\",\n        \"encoding\":  \"raw\",\n        \"username\":  username,\n        \"returnUrl\": returnUrl,\n    };\n\n    window.jQuery.ajax({\n        type:     \"POST\",\n        url:      callback_url,\n        data:     postBackData,\n        dataType: \"json\"\n    })\n        .done(function (jsonData) {\n            akeeba_passwordless_handle_login_challenge(jsonData, callback_url);\n        })\n        .fail(function (error) {\n            akeeba_passwordless_handle_login_error(error.status + \" \" + error.statusText);\n        });\n\n    return false;\n}\n\n/**\n * Handles the browser response for the user interaction with the authenticator. Redirects to an internal page which\n * handles the login server-side.\n *\n * @param {  Object}  publicKey     Public key request options, returned from the server\n * @param   {String}  callback_url  The URL we will use to post back to the server. Must include the anti-CSRF token.\n */\nfunction akeeba_passwordless_handle_login_challenge(publicKey, callback_url)\n{\n    function arrayToBase64String(a)\n    {\n        return btoa(String.fromCharCode(...a));\n    }\n\n    if (!publicKey.challenge)\n    {\n        akeeba_passwordless_handle_login_error(Joomla.JText._('PLG_SYSTEM_WEBAUTHN_ERR_INVALID_USERNAME'));\n\n        return;\n    }\n\n    publicKey.challenge        = Uint8Array.from(window.atob(publicKey.challenge), c => c.charCodeAt(0));\n    publicKey.allowCredentials = publicKey.allowCredentials.map(function (data) {\n        return {\n            ...data,\n            \"id\": Uint8Array.from(atob(data.id), c => c.charCodeAt(0))\n        };\n    });\n\n    navigator.credentials.get({publicKey})\n        .then(data => {\n            let publicKeyCredential = {\n                id:       data.id,\n                type:     data.type,\n                rawId:    arrayToBase64String(new Uint8Array(data.rawId)),\n                response: {\n                    authenticatorData: arrayToBase64String(new Uint8Array(data.response.authenticatorData)),\n                    clientDataJSON:    arrayToBase64String(new Uint8Array(data.response.clientDataJSON)),\n                    signature:         arrayToBase64String(new Uint8Array(data.response.signature)),\n                    userHandle:        data.response.userHandle ? arrayToBase64String(\n                        new Uint8Array(data.response.userHandle)) : null\n                }\n            };\n\n            window.location = callback_url + '&option=com_ajax&group=system&plugin=webauthn&format=raw&akaction=login&encoding=redirect&data=' +\n                btoa(JSON.stringify(publicKeyCredential));\n\n        }, error => {\n            // Example: timeout, interaction refused...\n            console.log(error);\n            akeeba_passwordless_handle_login_error(error);\n        });\n}\n\n/**\n * A simple error handler.\n *\n * @param   {String}  message\n */\nfunction akeeba_passwordless_handle_login_error(message)\n{\n    alert(message);\n\n    console.log(message);\n}\n\n/**\n * Moves the passwordless login button next to the existing Login button in the login module, if possible. This is not a\n * guaranteed success! We will *try* to find a button that looks like the login action button. If the developer of the\n * module or the site integrator doing template overrides didn't bother including some useful information to help us\n * identify it we're probably going to fail hard.\n *\n * @param   {Element}  elPasswordlessLoginButton  The login button to move.\n * @param   {Array}    possibleSelectors          The CSS selectors to use for moving the button.\n */\n\nfunction akeeba_passwordless_login_move_button(elPasswordlessLoginButton, possibleSelectors)\n{\n    if ((elPasswordlessLoginButton === null) || (elPasswordlessLoginButton === undefined))\n    {\n        return;\n    }\n\n    var elLoginBtn = null;\n\n    for (var i = 0; i < possibleSelectors.length; i++)\n    {\n        var selector = possibleSelectors[i];\n\n        elLoginBtn = akeeba_passwordless_lookInParentElementsForField(elPasswordlessLoginButton, selector);\n\n        if (elLoginBtn !== null)\n        {\n            break;\n        }\n    }\n\n    if (elLoginBtn === null)\n    {\n        return;\n    }\n\n    elLoginBtn.parentElement.appendChild(elPasswordlessLoginButton);\n}"],"file":"login.js"}