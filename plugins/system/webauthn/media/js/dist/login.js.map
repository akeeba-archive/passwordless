{"version":3,"sources":["../login.js"],"names":["akeeba_passwordless_login","that","callback_url","findNamedField","elForm","fieldName","elInputs","querySelectorAll","length","i","elInput","name","trawlParentElements","innerElement","elElement","parentElement","nodeName","elForms","elUsername","elReturn","alert","Joomla","JText","_","username","value","returnUrl","postBackData","window","jQuery","ajax","type","url","data","dataType","done","jsonData","akeeba_passwordless_handle_login_challenge","fail","error","akeeba_passwordless_handle_login_error","status","statusText","publicKey","arrayToBase64String","a","btoa","String","fromCharCode","challenge","Uint8Array","from","atob","c","charCodeAt","allowCredentials","map","id","navigator","credentials","get","then","publicKeyCredential","rawId","response","authenticatorData","clientDataJSON","signature","userHandle","location","JSON","stringify","console","log","message"],"mappings":"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","sourcesContent":["/**\n * @package   AkeebaPasswordlessLogin\n * @copyright Copyright (c)2018-2019 Nicholas K. Dionysopoulos / Akeeba Ltd\n * @license   GNU General Public License version 3, or later\n */\n\n// TODO Write the akeeba_passwordless_login() function\n// See https://github.com/web-auth/webauthn-framework/blob/v1.0/doc/webauthn/PublicKeyCredentialRequest.md\n\nfunction akeeba_passwordless_login(that, callback_url)\n{\n    function findNamedField(elForm, fieldName)\n    {\n        let elInputs = elForm.querySelectorAll(\"input\");\n\n        if (!elInputs.length)\n        {\n            return null;\n        }\n\n        for (var i = 0; i < elInputs.length; i++)\n        {\n            var elInput = elInputs[i];\n\n            if (elInput.name === fieldName)\n            {\n                return elInput;\n            }\n        }\n\n        return null;\n    }\n\n    function trawlParentElements(innerElement, fieldName)\n    {\n        var elElement = innerElement.parentElement;\n        var elInput   = null;\n\n        while (true)\n        {\n            if (elElement.nodeName === \"FORM\")\n            {\n                elInput = findNamedField(elElement, fieldName);\n\n                if (elInput !== null)\n                {\n                    return elInput;\n                }\n\n                break;\n            }\n\n            var elForms = elElement.querySelectorAll(\"form\");\n\n            if (elForms.length)\n            {\n                for (var i = 0; i < elForms.length; i++)\n                {\n                    elInput = findNamedField(elForms[i], fieldName);\n\n                    if (elInput !== null)\n                    {\n                        return elInput;\n                    }\n                }\n            }\n\n            if (!elElement.parentElement)\n            {\n                break;\n            }\n\n            elElement = elElement.parentElement;\n        }\n\n        return null;\n    }\n\n    // Get the username\n    let elUsername = trawlParentElements(that, \"username\");\n    let elReturn   = trawlParentElements(that, \"return\");\n\n    if (elUsername === null)\n    {\n        alert(Joomla.JText._(\"PLG_SYSTEM_WEBAUTHN_ERR_CANNOT_FIND_USERNAME\"));\n\n        return false;\n    }\n\n    let username  = elUsername.value;\n    let returnUrl = elReturn ? elReturn.value : null;\n\n    // No username? We cannot proceed. We need a username to find the acceptable public keys :(\n    if (username === \"\")\n    {\n        alert(Joomla.JText._(\"PLG_SYSTEM_WEBAUTHN_ERR_EMPTY_USERNAME\"));\n\n        return false;\n    }\n\n    // Get the Public Key Credential Request Options (challenge and acceptable public keys)\n    let postBackData = {\n        \"option\":    \"com_ajax\",\n        \"group\":     \"system\",\n        \"plugin\":    \"webauthn\",\n        \"format\":    \"raw\",\n        \"akaction\":  \"challenge\",\n        \"encoding\":  \"raw\",\n        \"username\":  username,\n        \"returnUrl\": returnUrl,\n    };\n\n    window.jQuery.ajax({\n        type:     \"POST\",\n        url:      callback_url,\n        data:     postBackData,\n        dataType: \"json\"\n    })\n        .done(function (jsonData) {\n            akeeba_passwordless_handle_login_challenge(jsonData, callback_url);\n        })\n        .fail(function (error) {\n            akeeba_passwordless_handle_login_error(error.status + \" \" + error.statusText);\n        })\n\n\n}\n\nfunction akeeba_passwordless_handle_login_challenge(publicKey, callback_url)\n{\n    function arrayToBase64String(a)\n    {\n        return btoa(String.fromCharCode(...a));\n    }\n\n    if (!publicKey.challenge)\n    {\n        akeeba_passwordless_handle_login_error(Joomla.JText._('PLG_SYSTEM_WEBAUTHN_ERR_INVALID_USERNAME'));\n\n        return;\n    }\n\n    publicKey.challenge        = Uint8Array.from(window.atob(publicKey.challenge), c => c.charCodeAt(0));\n    publicKey.allowCredentials = publicKey.allowCredentials.map(function (data) {\n        return {\n            ...data,\n            \"id\": Uint8Array.from(atob(data.id), c => c.charCodeAt(0))\n        };\n    });\n\n    navigator.credentials.get({publicKey})\n        .then(data => {\n            let publicKeyCredential = {\n                id:       data.id,\n                type:     data.type,\n                rawId:    arrayToBase64String(new Uint8Array(data.rawId)),\n                response: {\n                    authenticatorData: arrayToBase64String(new Uint8Array(data.response.authenticatorData)),\n                    clientDataJSON:    arrayToBase64String(new Uint8Array(data.response.clientDataJSON)),\n                    signature:         arrayToBase64String(new Uint8Array(data.response.signature)),\n                    userHandle:        data.response.userHandle ? arrayToBase64String(\n                        new Uint8Array(data.response.userHandle)) : null\n                }\n            };\n\n            window.location = callback_url + '&option=com_ajax&group=system&plugin=webauthn&format=raw&akaction=login&encoding=redirect&data=' +\n                btoa(JSON.stringify(publicKeyCredential));\n\n        }, error => {\n            // Example: timeout, interaction refused...\n            console.log(error);\n            akeeba_passwordless_handle_login_error(error);\n        });\n}\n\n/**\n * A simple error handler\n *\n * @param   {String}  message\n */\nfunction akeeba_passwordless_handle_login_error(message)\n{\n    alert(message);\n\n    console.log(message);\n}\n"],"file":"login.js"}